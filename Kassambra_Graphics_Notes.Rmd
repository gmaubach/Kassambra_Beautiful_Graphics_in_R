---
title: "Beautiful Graphics"
subtitle: "Notes to the book by Alboukadel Kassambara"
author:
- name: "Georg Maubach"
  affiliation: "Veikko Consulting"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    self_contained: yes
    toc: no
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    toc_title: "Table of Contents"
  pdf_document:
    keep_md: yes
    number_sections: yes
    toc: no
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_title: "Table of Contents"
  word_document:
    toc: no
    toc_depth: 3
keywords: graphics, notes, ggplot2
linestretch: 1
fontsize: 11pt
tags:
- graphics
- notes
- ggplot2
abstract: |
  This document contains notes while reading the book.
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The is http://www.sthda.com/english/wiki/ggplot2-essentials.

# Introduction
## Installing and Loading ggplot2
```{r eval = FALSE}
warning("Use type = 'source' only if you have configured a C++ compiler.")

local({
  r = getOption("repos")
  r["CRAN"] = "https://cran.rstudio.com/"
  r["CRANextra"] <- "http://www.stats.ox.ac.uk/pub/RWin"
  r["CRAN_de"] <- "https://cran.uni-muenster.de/"
  options(repos = r)
})

install.packages(
  pkgs = "ggplot2", 
  dependencies = TRUE,
  type = "source")

library(ggplot2)
```


# Introduction to ggplot2
## Terms
A plot can be divided into **3** fundumental parts:
**Plot = data + Aesthetics + Geometry**.

- **data**: a data frame
- **Aesthetics**: describe the mapping of variables to visual properties of geometry.
    1. indicate the x and y variables,  
    2. control color, size, shape of points, etc. 
- **Geometry**: describe the type of graphic, e.g. histogram, box plot, line plot, scatter plot, etc.

Geometry is defined in geom_*(). Geoms are called layers cause the can occur multiple times and put on top of each other.

### Further reading
- http://docs.ggplot2.org/0.9.3/aes.html
- http://docs.ggplot2.org/current/vignettes/ggplot2-specs.html

## Data format and preparation
- **Data must be a data frame, containing all information to make a ggplot graphic.**  
- **Data should be tidy, i. e. columns should be variables, rows should be observations.**  

```{r}
# mtcars
## Load data
data(mtcars)
df <- mtcars[ , c("mpg", "cyl", "wt")]

## Convert dyl to a factor variable
df$cyl <- as.factor(df$cyl)

## Print a sample of data
head(mtcars)

#----------------------------------------------------------
library(dplyr)

set.seed(1234)
wdata <- data.frame(
  sex = factor(rep(c("F", "M"), each = 200)),
  weight = c(rnorm(200, 55), rnorm(200, 58)))

head(wdata)

mu <- wdata %>%
  group_by(sex) %>%
  summarise(grp.mean = mean(weight))

head(mu)
```

## ggplot Basics
### ggplot basic example
```{r}
library(ggplot2)
# Basic scatter plot
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
  geom_point()

# Change the font size and shape
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
   geom_point(size = 1.5, shape = 18)
```

### aes_string()
aes_string() generates aesthetics from a string. This is particularly useful when writing functions that create plots cause strings can be used to define aesthetic mappings. Otherwise it would be needed to use a substitute to generate a call to aes().

```{r}
ggplot(data = mtcars, aes_string(x = "wt", y = "mpg")) +
   geom_point(size = 1.5, shape = 18)

ggpoints <- function(data, x_name, y_name)
{
  p <- ggplot(data = data, aes_string(x_name, y_name)) +
    geom_point(color = "red") +
    geom_smooth()
  
  return(p)
}

ggpoints(data = mtcars, x_name = "wt", y_name = "mpg")
```

### Visualise transformations of original dataset
Some plots visualise a transformation on the original data set. In this case, an alternative way to build a layer is to use stat_*() functions.

```{r}
set.seed(1234)
wdata = data.frame(
  sex = factor(rep(c("F", "M"), each = 200)),
  weight = c(rnorm(200, 55), rnorm(200, 58)))

print("Use geometry function")
ggplot(wdata, aes(x = weight)) + geom_density()

print("Use stat function")
ggplot(wdata, aes(x = weight)) + stat_density()
```

### Layers using geoms
Each plot consists of one or more layers. Layers are defined using geom_*().

#### Using the same data and same aesthetic mapping in one plot
```{r}
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
  geom_point() +  # to draw points
  geom_line()     # to draw a line
```

#### Using different data and mappings for different layers
```{r}
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
  geom_point() +  # to draw points from whole data set
  geom_line(data = head(mtcars), color = "red")  # to draw a line from a subset of data
```

### Calculations in aes()
```{r}
ggplot(data = mtcars, aes(x = log2(wt), y = log2(mpg))) +
  geom_point()
```

### Saving plots
- Plots can be stored as a variable and printed using print().  
- last_plot(): returns last plot modified  
- ggsave("plot.png", width = 5, height = 5): save the last plot to the current working directory  

#### Saving directly from screen
```{r}
ggplot(mtcars, aes(wt, mpg)) + geom_point()
ggsave("my_plot1.pdf")  # to PDF
ggsave("my_plot1.png")  # to PNG
```

#### Saving graphic objects
```{r}
pdf("my_plot2.pdf")
my_plot <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
print(my_plot)
dev.off()

png("my_plot2.png")
my_plot <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
print(my_plot)
dev.off()
```

# Plotting **ONE** variable (discrete or continuous)

```{r}
library(dplyr)

set.seed(1234)
wdata <- data.frame(
  sex = factor(rep(c("F", "M"), each = 200)),
  weight = c(rnorm(200, 55), rnorm(200, 58)))

head(wdata)

mu <- wdata %>%
  group_by(sex) %>%
  summarise(grp.mean = mean(weight))

head(mu)
```

```{r}
my_plot <- ggplot(wdata, aes(x = weight))
```

## Overview of possible graphics

### Discrete Variables

- geom_bar(): bar plot

### Continuous Variables

- geom_area():      area plot
- geom_density():   density plot
- geom_dotplot():   dot plot
- geom_freqpoly():  frequency polygon
- geom_histogram(): histogram plot
- geom_ecdf():      empirical cumulative density function
- stat_qq():        quantile-quantile plot

## Bar plot

## Area Plot
### Basics
- Definitio: Area plots are the continuous analog to a stacked bar chart.
- Key function: geom_area()
- Alternative function: stat_bin()
- Key arguments: alpha, color, fill, linetype, size

### Example 1: y Values Corresponding to the Count of x Values

```{r}
my_plot + geom_area(stat = "bin", color = "black", fill = '#00AFBB')
```

### Example 2: y Values Corresponding to the Density of x Values
```{r}
my_plot + geom_area(aes(y = ..density..), stat = "bin")
```

### Comparison of Bar Plot and Area Plot
```{r}
data("diamonds")
head(diamonds)

p <- ggplot(diamonds, aes(x = price, fill = cut))

p + geom_bar(stat = "bin")

p + geom_area(stat = "bin")
```

## Density Plot
### Basics
- Density plots are useful to visualise the distribution of a continuous variable.
- Key function: geom_density()
- Alternative function: stat_density()
- Key arguments: alpha, color, fill, linetype, size
- References
    1. https://en.wikipedia.org/wiki/Density_estimation
    2. https://de.wikipedia.org/wiki/Kerndichtesch%C3%A4tzer

### Example 1
```{r}
my_plot + geom_density()

my_plot + geom_density(color = "black", fill = "grey") +
  geom_vline(aes(xintercept = mean(weight)),
             color = "#FC4E07", 
             linetype = "dashed",
             size = 1)
```

### Groupings
#### Example 1: Line Color by Sex
```{r}
my_plot + geom_density(aes(color = sex))
```

#### Example 2: Fill Color by Sex, semi-transparent fill (alpha = 0.4)
```{r}
my_plot + geom_density(aes(fill = sex), 
                       alpha = 0.4)
```

#### Example 3: Line Color and Mean Line by Sex
```{r}
head(mu)
my_plot + geom_density(aes(color = sex), 
                        alpha = 0.4) +
  geom_vline(data = mu,
             aes(xintercept = grp.mean, 
                 color = sex),
             linetype = "dashed")
```

### Graphic Property Control
#### Basics
- scale_color_manual(), scale_fill_manual(): use custom colors
- scale_color_brewer(), scale_fill_brewer(): use color palette from RColorBrewer package
- scale_color_grey(), scale_fill_grey():     use grey color palettes

#### Manually Defined Lines
##### Example 0: Create Basic Graphic
```{r}
my_plot_2 <- my_plot + 
  geom_density(aes(color = sex)) +
  geom_vline(data = mu,
             aes(xintercept = grp.mean, 
                 color = sex),
             linetype = "dashed") +
  theme_minimal()
```

##### Example 1: Manually Defined Color
```{r}
my_plot_2 + scale_color_manual(values = c("#999999", "#E69F00"))
```

##### Example 2: Colors Using RColorBrewer Palettes
```{r}
my_plot_2 + scale_color_brewer(palette = "Paired")
```

##### Example 3: Grey Scale
```{r}
my_plot_2 + scale_color_grey()
```

#### Manually Defined Fills
##### Example 0: Create Basic Graphic
```{r}
my_plot_3 <- my_plot + 
  geom_density(aes(fill = sex), alpha = 0.4) +
  theme_minimal()
```

##### Example 1: Manuall Fill
```{r}
my_plot_3 + scale_fill_manual(
  values = c("#999999", "#E69F00"))
```

##### Example 2: Fill with RColorBrewer Palettes Colors
```{r}
my_plot_3 + scale_fill_brewer(palette = "Dark2") +
  theme_minimal()
```

##### Example 3: Fill with Grey Scale Colors
```{r}
my_plot_3 + scale_fill_grey() +
  theme_minimal()
```

